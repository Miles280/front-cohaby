@if (listing) {
<section class="bg-white py-10 px-6 border-b">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold text-dark mb-2">{{ listing.title }}</h1>
    <p class="text-lg text-grayish mb-4">{{ listing.description }}</p>
    <div class="flex flex-wrap gap-4 text-lg text-primary font-semibold">
      <p>Prix / nuit : {{ listing.pricePerNight }} €</p>
      <p>Capacité max : {{ listing.maxCapacity }} personnes</p>
    </div>
  </div>
</section>

<!-- Image principale avec clic -->
@if (listing && listing.pictures && listing.pictures.length > 0 &&
listing.pictures[currentPictureIndex]) {
<img
  [src]="listing.pictures[currentPictureIndex].url"
  alt="Photo logement"
  class="rounded-xl shadow-md object-cover w-full h-96 mx-auto transition-all duration-300 cursor-pointer"
  (click)="openModal()"
/>
}

<!-- Boutons gauche/droite -->
<div class="flex justify-center gap-4 mt-4">
  <button (click)="showPreviousPicture()" class="text-2xl">←</button>
  <button (click)="showNextPicture()" class="text-2xl">→</button>
</div>

<!-- Modale avec @if -->
@if (isModalOpen && listing && listing.pictures && listing.pictures.length > 0
&& listing.pictures[currentPictureIndex]) {
<div
  class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center"
  (click)="closeModal()"
>
  <div
    class="relative max-w-5xl w-full px-4"
    (click)="$event.stopPropagation()"
  >
    @if (listing && listing.pictures && listing.pictures.length > 0 &&
    listing.pictures[currentPictureIndex]) {
    <img
      [src]="listing.pictures[currentPictureIndex].url"
      alt="Photo logement"
      class="rounded-xl shadow-md object-cover w-full h-96 mx-auto transition-all duration-300 cursor-pointer"
      (click)="openModal()"
    />
    }

    <!-- Bouton de fermeture -->
    <button
      (click)="closeModal()"
      class="absolute top-4 right-4 text-white text-3xl font-bold"
      aria-label="Fermer"
    >
      ✕
    </button>
  </div>
</div>
}

<section class="bg-white py-14 px-6 border-t border-gray-200">
  <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-10">
    <!-- Services inclus -->
    @if (listing && listing.services && listing.services.length > 0) {
    <div>
      <h2 class="text-2xl font-bold text-primary mb-4">Services inclus</h2>
      <ul class="space-y-3">
        @for (service of listing.services; track service) {
        <li class="flex items-start gap-2">
          <mat-icon>{{ service.icon }}</mat-icon>
          <div>
            <p class="font-semibold text-dark">{{ service.name }}</p>
            <p class="text-sm text-grayish">{{ service.description }}</p>
          </div>
        </li>
        }
      </ul>
    </div>
    }

    <!-- Équipements -->
    @if (listing && listing.equipments && listing.equipments.length > 0) {
    <div>
      <h2 class="text-2xl font-bold text-primary mb-4">Équipements</h2>
      <ul class="space-y-3">
        @for (equip of listing.equipments; track equip) {
        <li class="flex items-start gap-2">
          <mat-icon>{{ equip.icon }}</mat-icon>
          <div>
            <p class="font-semibold text-dark">{{ equip.name }}</p>
            <p class="text-sm text-grayish">{{ equip.description }}</p>
          </div>
        </li>
        }
      </ul>
    </div>
    }
  </div>
</section>

<section class="bg-light py-12 px-6 border-t">
  <div class="max-w-6xl mx-auto text-dark">
    @if (listing.owner) {
    <p class="mb-2">
      <strong>Propriétaire :</strong> {{ listing.owner.firstname }}
      {{ listing.owner.lastname }}
    </p>
    } @if (listing.address) {
    <p>
      <strong>Adresse :</strong> {{ listing.address.street }},
      {{ listing.address.city }} ({{ listing.address.postalCode }})
    </p>
    }
  </div>
</section>

@if (isLoggedIn) {
<section class="bg-white py-8 px-6 border-t">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">Réserver ce logement</h2>
  <form
    [formGroup]="bookingForm"
    (ngSubmit)="onSubmit()"
    class="flex flex-col gap-6 p-6 border rounded-2xl shadow-md max-w-md mx-auto"
  >
    <!-- Date de début -->
    <div class="flex flex-col">
      <label class="font-medium text-gray-700 mb-1">Date de début :</label>
      <input
        type="date"
        formControlName="beginningDate"
        class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
      />
      <span
        *ngIf="
          bookingForm.get('beginningDate')?.invalid &&
          bookingForm.get('beginningDate')?.touched
        "
        class="text-sm text-red-500 mt-1"
      >
        La date est obligatoire
      </span>
    </div>

    <!-- Nombre de nuits -->
    <div class="flex flex-col">
      <label class="font-medium text-gray-700 mb-1">Nombre de nuits :</label>
      <input
        type="number"
        formControlName="totalNights"
        min="1"
        class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
      />
    </div>

    <!-- Nombre d'invités -->
    <div class="flex flex-col">
      <label class="font-medium text-gray-700 mb-1">Nombre d'invités :</label>
      <input
        type="number"
        formControlName="nbrGuests"
        min="1"
        class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
      />
    </div>

    <!-- Bouton -->
    <button
      type="submit"
      [disabled]="bookingForm.invalid"
      class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white font-semibold px-4 py-2 rounded-lg shadow transition-colors"
    >
      Réserver
    </button>
  </form>
</section>

} @else {
<p class="text-center text-gray-500">Connectez-vous pour réserver.</p>
} } @else {
<p>Chargement en cours...</p>
}
